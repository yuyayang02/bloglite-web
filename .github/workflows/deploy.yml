name: "éƒ¨ç½²åˆ°æœåŠ¡å™¨"

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'   # ä»…åŒ¹é… v1.2.3 æ ¼å¼çš„ tag

jobs:
  deploy:
    name: "ğŸš€ éƒ¨ç½²ä»»åŠ¡"
    runs-on: ubuntu-latest

    steps:
      - name: "ğŸ§¾ æ£€å‡ºä»£ç "
        uses: actions/checkout@v4

      - name: "ğŸ” è®¾ç½® SSH è¿æ¥"
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: "ğŸš€ å¼€å§‹éƒ¨ç½²"
        run: |
          echo "âš™ï¸ éƒ¨ç½²å¼€å§‹..."
          echo "ğŸ“¦ é¡¹ç›®åï¼š${{ github.repository }}"
          echo "ğŸŒ é¡¹ç›®åœ°å€ï¼šhttps://github.com/${{ github.repository }}"
          echo "ğŸ·ï¸ å½“å‰éƒ¨ç½²æ ‡ç­¾ï¼š${{ github.ref_name }}"

          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} <<'EOF'

            set -e

            cd ${{ secrets.DEPLOY_DIR }}
            PROJECT_DIR=$(basename "${{ github.repository }}")

            if [ ! -d "$PROJECT_DIR" ]; then
              echo "ğŸ”§ é¦–æ¬¡éƒ¨ç½²ï¼šå…‹éš†ä»“åº“"
              git clone https://github.com/${{ github.repository }}.git "$PROJECT_DIR"
            else
              echo "ğŸ”„ å·²å­˜åœ¨é¡¹ç›®ç›®å½•ï¼Œæ‹‰å–å¹¶åˆ‡æ¢ç‰ˆæœ¬æ ‡ç­¾"
              cd "$PROJECT_DIR"
              git fetch --tags
              git checkout ${{ github.ref_name }}
              cd ..
            fi

            echo "ğŸ³ ä½¿ç”¨ docker-compose å¯åŠ¨æœåŠ¡"
            docker-compose -p "$PROJECT_DIR" up -d --build --no-deps web
          EOF

      - name: âœ… éƒ¨ç½²å®Œæˆé€šçŸ¥
        run: |
          echo "ğŸ‰ éƒ¨ç½²ä»»åŠ¡å·²å®Œæˆ"
          echo "----------------------------------"
          echo "ğŸ“¦ é¡¹ç›®åç§°ï¼š${{ github.repository }}"
          echo "ğŸŒ ä»“åº“åœ°å€ï¼šhttps://github.com/${{ github.repository }}"
          echo "ğŸ·ï¸ éƒ¨ç½²ç‰ˆæœ¬ï¼š${{ github.ref_name }}"